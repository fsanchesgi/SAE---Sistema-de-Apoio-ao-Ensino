<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cadastro - SAE</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<h1>Cadastro - SAE</h1>
<form id="formCadastro">
    <input type="text" id="nome" placeholder="Nome completo" required>
    <input type="email" id="email" placeholder="Email" required>
    <input type="password" id="senha" placeholder="Senha" required>
    <select id="role" required>
        <option value="">Selecione o perfil</option>
        <option value="aluno">Aluno</option>
        <option value="pai">Pai</option>
        <option value="professor">Professor</option>
        <option value="admin">Admin</option>
    </select>
    <button type="submit">Cadastrar</button>
</form>
<p>Já tem conta? <a href="login.html">Login</a></p>

<h2>Perfis cadastrados:</h2>
<ul id="listaPerfis"></ul>

<script>
  // Carrega Supabase dinamicamente
  const script = document.createElement('script');
  script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js';
  script.onload = () => {
    const supabaseClient = supabase.createClient(
      'https://vhwhjnghtmlrfieiwssi.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZod2hqbmdodG1scmZpZWl3c3NpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5OTM4OTUsImV4cCI6MjA4MTU2OTg5NX0.XV6vxBeRtIcDNEGsJuDU_wPcnm2qmK8ZoHEuHQR2TMU'
    );

    console.log("SupabaseClient carregado com sucesso!");

    const formCadastro = document.getElementById('formCadastro');
    const listaPerfis = document.getElementById('listaPerfis');

    // Função para listar perfis
    async function listarPerfis() {
      const { data, error } = await supabaseClient.from('profiles').select('*');
      if (error) {
        console.error("Erro ao buscar perfis:", error);
        return;
      }
      listaPerfis.innerHTML = '';
      data.forEach(perfil => {
        const li = document.createElement('li');
        li.textContent = `${perfil.nome} (${perfil.role}) - ID: ${perfil.id}`;
        listaPerfis.appendChild(li);
      });
    }

    // Carrega perfis ao abrir a página
    listarPerfis();

    formCadastro.addEventListener('submit', async (e) => {
      e.preventDefault();

      const nome = document.getElementById('nome').value.trim();
      const email = document.getElementById('email').value.trim();
      const senha = document.getElementById('senha').value.trim();
      const role = document.getElementById('role').value;

      if (!nome || !email || !senha || !role) { 
        alert("Preencha todos os campos"); 
        return; 
      }

      try {
        console.log("Tentando criar usuário no Auth...");
        const { data: signUpData, error: signUpError } = await supabaseClient.auth.signUp({
          email,
          password: senha
        });

        if (signUpError) {
          console.error("Erro no Auth:", signUpError);
          alert("Erro no Auth: " + signUpError.message);
          return;
        }

        console.log("Usuário Auth criado com sucesso:", signUpData.user);
        const userId = signUpData.user.id;

        console.log("Tentando inserir perfil no banco...");
        const { data: perfilData, error: perfilError } = await supabaseClient.from('profiles').insert([{
          id: userId,
          nome,
          role
        }]);

        if (perfilError) {
          console.error("Erro ao inserir perfil:", perfilError);
          alert("Erro ao criar perfil: " + perfilError.message);
          return;
        }

        console.log("Perfil inserido com sucesso:", perfilData);
        alert("Cadastro realizado com sucesso! Faça login agora.");

        // Atualiza lista de perfis na página
        listarPerfis();

        // Redireciona para login
        // window.location.href = 'login.html';

      } catch (err) {
        console.error("Erro inesperado no cadastro:", err);
        alert("Erro inesperado: " + err.message);
      }
    });
  };
  document.head.appendChild(script);
</script>
</body>
</html>
