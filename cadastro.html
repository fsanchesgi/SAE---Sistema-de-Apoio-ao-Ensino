<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Cadastro de Usuário</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #f5f5f5; }
        form { max-width: 400px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; }
        input, select, button { width: 100%; padding: 10px; margin: 8px 0; border-radius: 4px; border: 1px solid #ccc; }
        button { background-color: #4CAF50; color: white; border: none; cursor: pointer; }
        button:hover { background-color: #45a049; }
        h2 { text-align: center; }
    </style>
</head>
<body>

<h2>Cadastro de Usuário</h2>

<form id="cadastroForm">
    <label for="nome">Nome:</label>
    <input type="text" id="nome" required>

    <label for="email">E-mail:</label>
    <input type="email" id="email" required>

    <label for="role">Tipo de Usuário:</label>
    <select id="role" required>
        <option value="">Selecione</option>
        <option value="aluno">Aluno</option>
        <option value="professor">Professor</option>
        <option value="pai">Pai</option>
    </select>

    <label for="instituicao">Instituição:</label>
    <select id="instituicao" required>
        <option value="">Carregando instituições...</option>
    </select>

    <button type="submit">Cadastrar</button>
</form>

<script>
    // Conexão com Supabase
    const supabaseUrl = 'https://uqwbduinwugaqexsvkxc.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsImtpZCI6ImJDb3JXVmV2dnNGb3RpS2kiLCJ0eXAiOiJKV1QifQ.eyJpc3MiOiJodHRwczovL3Vxd2JkdWlud3VnYXFleHN2a3hjLnN1cGFiYXNlLmNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE2OTk5OTk5OTksImV4cCI6MTk5OTk5OTk5OX0.xxxxx'; // sua anon public key
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    // Carregar instituições
    async function carregarInstituicoes() {
        const { data, error } = await supabase.from('instituicoes').select('id, nome').order('nome');
        const select = document.getElementById('instituicao');
        select.innerHTML = '<option value="">Selecione</option>';
        if (error) {
            alert('Erro ao carregar instituições: ' + error.message);
            return;
        }
        data.forEach(inst => {
            const option = document.createElement('option');
            option.value = inst.id;
            option.textContent = inst.nome;
            select.appendChild(option);
        });
    }

    carregarInstituicoes();

    // Cadastro de usuário
    document.getElementById('cadastroForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const nome = document.getElementById('nome').value.trim();
        const email = document.getElementById('email').value.trim();
        const role = document.getElementById('role').value;
        const instituicaoId = document.getElementById('instituicao').value;

        if (!nome || !email || !role || !instituicaoId) {
            alert('Preencha todos os campos.');
            return;
        }

        try {
            // Criar usuário no Auth
            const { data: userData, error: signUpError } = await supabase.auth.signUp({
                email: email,
                password: Math.random().toString(36).slice(-8) // senha aleatória temporária
            });

            if (signUpError) {
                alert('Erro ao criar usuário: ' + signUpError.message);
                return;
            }

            const userId = userData.user.id;

            // Inserir no profiles
            const { error: profileError } = await supabase.from('profiles').insert([{
                id: userId,
                nome: nome,
                role: role
            }]);

            if (profileError) {
                alert('Erro ao inserir profile: ' + profileError.message);
                return;
            }

            // Vincular à tabela específica (alunos, professores ou pais)
            let tabela = '';
            let insertData = { user_id: userId };
            switch(role) {
                case 'aluno':
                    tabela = 'alunos';
                    insertData.turma_id = null; // pode ser ajustado depois
                    break;
                case 'professor':
                    tabela = 'professores';
                    insertData.turma_id = null; // pode ser ajustado depois
                    break;
                case 'pai':
                    tabela = 'pais';
                    insertData.aluno_id = null; // precisa ser vinculado posteriormente
                    break;
            }

            if (tabela) {
                const { error: roleError } = await supabase.from(tabela).insert([insertData]);
                if (roleError) {
                    alert('Erro ao vincular ' + role + ': ' + roleError.message);
                    return;
                }
            }

            alert('Usuário cadastrado com sucesso! Senha enviada para e-mail.');
            document.getElementById('cadastroForm').reset();

        } catch (err) {
            console.error(err);
            alert('Ocorreu um erro no cadastro.');
        }
    });
</script>

</body>
</html>
